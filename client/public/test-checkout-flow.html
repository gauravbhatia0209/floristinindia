<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout Flow Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .pass {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .fail {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .loading {
        opacity: 0.6;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .summary {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Checkout and Payment Flow Test</h1>
    <p>
      This page tests the checkout and payment APIs to ensure they're working
      correctly.
    </p>

    <div class="test-section">
      <h2>üîß Configuration</h2>
      <div id="config-info"></div>
    </div>

    <div class="test-section">
      <h2>üöÄ Quick Tests</h2>
      <button onclick="runAllTests()">Run All Tests</button>
      <button onclick="testPaymentMethods()">Test Payment Methods</button>
      <button onclick="testPaymentCreation()">Test Payment Creation</button>
      <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="test-section">
      <h2>üìä Test Results</h2>
      <div id="test-summary" class="summary" style="display: none"></div>
      <div id="test-results"></div>
    </div>

    <div class="test-section">
      <h2>üìã Manual Test Steps</h2>
      <ol>
        <li>
          Visit the <a href="/cart" target="_blank">Cart Page</a> and add some
          items
        </li>
        <li>
          Go to <a href="/checkout" target="_blank">Checkout</a> and fill the
          form
        </li>
        <li>Select Razorpay payment method</li>
        <li>Complete the payment flow</li>
        <li>Verify you reach the success page</li>
      </ol>
    </div>

    <script>
      let testResults = [];
      let testCount = 0;
      let passCount = 0;
      let failCount = 0;

      // Configuration
      const API_BASE = window.location.origin;

      function showConfig() {
        const config = {
          "API Base URL": API_BASE,
          "Current Page": window.location.href,
          "User Agent": navigator.userAgent.split(" ").slice(-2).join(" "),
          Timestamp: new Date().toISOString(),
        };

        document.getElementById("config-info").innerHTML = Object.entries(
          config,
        )
          .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
          .join("<br>");
      }

      function logResult(testName, passed, details = "", data = null) {
        testCount++;
        if (passed) passCount++;
        else failCount++;

        const result = {
          name: testName,
          passed,
          details,
          data,
          timestamp: new Date().toISOString(),
        };

        testResults.push(result);

        const resultDiv = document.createElement("div");
        resultDiv.className = `test-result ${passed ? "pass" : "fail"}`;
        resultDiv.innerHTML = `
                <strong>${passed ? "‚úÖ" : "‚ùå"} ${testName}</strong>
                ${details ? `<br><small>${details}</small>` : ""}
                ${data ? `<details><summary>Show data</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>` : ""}
            `;

        document.getElementById("test-results").appendChild(resultDiv);
        updateSummary();
      }

      function updateSummary() {
        const summaryDiv = document.getElementById("test-summary");
        summaryDiv.style.display = "block";
        summaryDiv.innerHTML = `
                <strong>Test Summary:</strong> 
                ${passCount} passed, ${failCount} failed, ${testCount} total
                (${testCount > 0 ? Math.round((passCount / testCount) * 100) : 0}% success rate)
            `;
      }

      async function makeRequest(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
            ...options,
          });

          const data = await response.json();
          return {
            success: response.ok,
            status: response.status,
            data,
            response,
          };
        } catch (error) {
          return {
            success: false,
            status: 0,
            error: error.message,
            data: null,
          };
        }
      }

      async function testPaymentMethods() {
        logResult("Starting", true, "Testing payment methods endpoint...");

        const result = await makeRequest(`${API_BASE}/api/payments/methods`);

        logResult(
          "Payment Methods API Response",
          result.success && result.status === 200,
          result.success
            ? "API responded successfully"
            : `Failed: ${result.error || "HTTP " + result.status}`,
          result.data,
        );

        if (result.success && result.data) {
          logResult(
            "Response Structure Valid",
            result.data.success === true && Array.isArray(result.data.methods),
            `success: ${result.data.success}, methods: ${Array.isArray(result.data.methods) ? "array" : typeof result.data.methods}`,
          );

          if (result.data.methods && result.data.methods.length > 0) {
            const hasRazorpay = result.data.methods.some(
              (m) => m.gateway === "razorpay",
            );
            logResult(
              "Razorpay Method Available",
              hasRazorpay,
              hasRazorpay ? "Razorpay found in methods" : "Razorpay not found",
            );

            const firstMethod = result.data.methods[0];
            logResult(
              "Method Fields Complete",
              firstMethod.gateway &&
                firstMethod.name &&
                typeof firstMethod.enabled === "boolean",
              `Gateway: ${firstMethod.gateway}, Name: ${firstMethod.name}, Enabled: ${firstMethod.enabled}`,
            );
          }
        }

        return result;
      }

      async function testPaymentCreation() {
        logResult("Starting", true, "Testing payment creation endpoint...");

        const testData = {
          gateway_id: "razorpay",
          amount: 50000, // 500 INR in paise
          currency: "INR",
          customer: {
            name: "Test Customer",
            email: "test@example.com",
            phone: "+919999999999",
            address: {
              line1: "Test Address",
              city: "Jalandhar",
              state: "Punjab",
              pincode: "144001",
              country: "IN",
            },
          },
          return_url: `${window.location.origin}/checkout/success`,
          cancel_url: `${window.location.origin}/checkout`,
          metadata: {
            test_payment: true,
            order_number: `TEST-${Date.now()}`,
          },
        };

        const result = await makeRequest(`${API_BASE}/api/payments/create`, {
          method: "POST",
          body: JSON.stringify(testData),
        });

        logResult(
          "Payment Creation API Response",
          result.status !== 0,
          result.success
            ? "API responded"
            : `Failed: ${result.error || "HTTP " + result.status}`,
          result.data,
        );

        if (result.data) {
          if (result.success && result.data.success) {
            logResult(
              "Payment Intent Created",
              !!result.data.payment_intent_id,
              result.data.payment_intent_id
                ? "Payment intent ID returned"
                : "No payment intent ID",
            );

            logResult(
              "Payment URL Generated",
              !!result.data.payment_url,
              result.data.payment_url
                ? `URL: ${result.data.payment_url}`
                : "No payment URL returned",
            );

            if (result.data.payment_url) {
              const hasParams =
                result.data.payment_url.includes("razorpay-payment") &&
                result.data.payment_url.includes("order_id");
              logResult(
                "Payment URL Valid",
                hasParams,
                hasParams
                  ? "URL contains required parameters"
                  : "URL missing required parameters",
              );
            }
          } else {
            logResult(
              "Payment Error Handled",
              !!result.data.error,
              `Error: ${result.data.error || "No error message provided"}`,
            );
          }
        }

        return result;
      }

      async function runAllTests() {
        clearResults();
        logResult(
          "Test Suite",
          true,
          "Starting comprehensive checkout flow tests...",
        );

        await testPaymentMethods();
        await testPaymentCreation();

        logResult("Test Suite Complete", true, `Finished ${testCount} tests`);
      }

      function clearResults() {
        testResults = [];
        testCount = 0;
        passCount = 0;
        failCount = 0;
        document.getElementById("test-results").innerHTML = "";
        document.getElementById("test-summary").style.display = "none";
      }

      function exportResults() {
        const results = {
          summary: {
            total: testCount,
            passed: passCount,
            failed: failCount,
            successRate:
              testCount > 0 ? Math.round((passCount / testCount) * 100) : 0,
            timestamp: new Date().toISOString(),
            apiBase: API_BASE,
          },
          tests: testResults,
        };

        const blob = new Blob([JSON.stringify(results, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `checkout-test-results-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        showConfig();

        // Add export button
        const exportBtn = document.createElement("button");
        exportBtn.textContent = "Export Results";
        exportBtn.onclick = exportResults;
        document.querySelector("button").parentNode.appendChild(exportBtn);
      });
    </script>
  </body>
</html>
