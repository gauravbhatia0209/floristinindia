<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Gateway Configuration Test</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 40px;
        background: #f8f9fa;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      button {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 8px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      pre {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .loading {
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”§ Payment Gateway Configuration Test</h1>
      <p>
        This page tests your payment gateway configuration to identify any
        issues.
      </p>

      <div id="results"></div>

      <button onclick="runAllTests()" id="testBtn">Run All Tests</button>
      <button onclick="testPaymentMethods()">Test Payment Methods API</button>
      <button onclick="testPaymentCreation()">Test Payment Creation</button>

      <div id="logs"></div>
    </div>

    <script>
      let logContainer;

      function log(message, type = "info") {
        if (!logContainer) {
          logContainer = document.getElementById("logs");
          logContainer.innerHTML = "<h3>ðŸ“‹ Test Logs</h3>";
        }

        const timestamp = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `test-result ${type}`;
        div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        logContainer.appendChild(div);

        console.log(`[${timestamp}] ${message}`);

        // Auto scroll to bottom
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      async function testPaymentMethods() {
        log("ðŸ”„ Testing payment methods API...", "info");

        try {
          const response = await fetch("/api/payments/methods");
          const data = await response.json();

          if (data.success && data.methods && data.methods.length > 0) {
            log(
              `âœ… Payment methods loaded successfully: ${data.methods.length} methods found`,
              "success",
            );

            data.methods.forEach((method) => {
              log(
                `   â€¢ ${method.name} (${method.gateway}) - ${method.enabled ? "Enabled" : "Disabled"}`,
                "info",
              );
            });

            const razorpayMethod = data.methods.find(
              (m) => m.gateway === "razorpay",
            );
            if (razorpayMethod) {
              log("ðŸŽ¯ Razorpay method found in configuration", "success");
            } else {
              log("âš ï¸ Razorpay method not found in configuration", "warning");
            }

            return true;
          } else {
            log(
              `âŒ Payment methods API failed: ${data.error || "No methods returned"}`,
              "error",
            );
            return false;
          }
        } catch (error) {
          log(`ðŸ’¥ Payment methods API error: ${error.message}`, "error");
          return false;
        }
      }

      async function testPaymentCreation() {
        log("ðŸ”„ Testing payment creation with Razorpay...", "info");

        const testPaymentData = {
          gateway_id: "razorpay",
          amount: 10000, // â‚¹100 in paise
          currency: "INR",
          customer: {
            name: "Test Customer",
            email: "test@example.com",
            phone: "+919999999999",
          },
          return_url: window.location.origin + "/checkout/success",
          cancel_url: window.location.origin + "/checkout",
          metadata: {
            order_number: `TEST-${Date.now()}`,
            test: true,
          },
        };

        try {
          const response = await fetch("/api/payments/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(testPaymentData),
          });

          const data = await response.json();

          if (data.success) {
            log("âœ… Payment creation successful!", "success");
            log(`   ðŸ“„ Payment Intent ID: ${data.payment_intent_id}`, "info");
            log(
              `   ðŸŽ« Razorpay Order ID: ${data.metadata.razorpay_order_id}`,
              "info",
            );
            log(`   ðŸ”‘ Razorpay Key ID: ${data.metadata.key_id}`, "info");
            log(`   ðŸ”— Payment URL: ${data.payment_url}`, "info");

            // Test the payment status endpoint
            await testPaymentStatus(data.payment_intent_id);

            return true;
          } else {
            log(`âŒ Payment creation failed: ${data.error}`, "error");
            if (data.details) {
              log(`   ðŸ“‹ Error details: ${data.details}`, "error");
            }
            if (data.code) {
              log(`   ðŸ·ï¸ Error code: ${data.code}`, "error");
            }
            if (data.next_steps) {
              log("   ðŸ“Œ Next steps:", "warning");
              data.next_steps.forEach((step) => {
                log(`     â€¢ ${step}`, "warning");
              });
            }
            return false;
          }
        } catch (error) {
          log(`ðŸ’¥ Payment creation error: ${error.message}`, "error");
          return false;
        }
      }

      async function testPaymentStatus(paymentIntentId) {
        log(`ðŸ” Testing payment status for: ${paymentIntentId}`, "info");

        try {
          const response = await fetch(
            `/api/payments/status/${paymentIntentId}`,
          );
          const data = await response.json();

          if (data.success) {
            log("âœ… Payment status check successful!", "success");
            log(`   ðŸ“Š Status: ${data.payment_intent.status}`, "info");
            log(
              `   ðŸ†” Gateway Order ID: ${data.payment_intent.gateway_order_id}`,
              "info",
            );
          } else {
            log(`âŒ Payment status check failed: ${data.error}`, "error");
          }
        } catch (error) {
          log(`ðŸ’¥ Payment status error: ${error.message}`, "error");
        }
      }

      async function runAllTests() {
        const testBtn = document.getElementById("testBtn");
        testBtn.disabled = true;
        testBtn.textContent = "Running Tests...";

        // Clear previous logs
        document.getElementById("logs").innerHTML = "";
        logContainer = null;

        log("ðŸš€ Starting payment gateway diagnostics...", "info");
        log("=" * 50, "info");

        // Test 1: Payment Methods
        const methodsResult = await testPaymentMethods();

        log("-" * 50, "info");

        // Test 2: Payment Creation (only if methods test passed)
        if (methodsResult) {
          await testPaymentCreation();
        } else {
          log(
            "â­ï¸ Skipping payment creation test (payment methods failed)",
            "warning",
          );
        }

        log("=" * 50, "info");
        log("ðŸ Diagnostics complete", "info");

        testBtn.disabled = false;
        testBtn.textContent = "Run All Tests";
      }

      // Auto-run tests on page load
      window.addEventListener("load", () => {
        log("ðŸ”§ Payment gateway diagnostic tool loaded", "info");
        log('Click "Run All Tests" to check your configuration', "info");
      });
    </script>
  </body>
</html>
