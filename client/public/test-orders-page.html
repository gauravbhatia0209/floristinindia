<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orders Page Test</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 40px;
        background: #f8f9fa;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      button {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 8px;
      }
      button:hover {
        background: #0056b3;
      }
      pre {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 4px;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ›’ Admin Orders Page Test</h1>
      <p>
        This page tests if the admin orders page and database connection is
        working.
      </p>

      <div id="results"></div>

      <button onclick="testOrdersPage()" id="testBtn">Test Orders Page</button>
      <button onclick="testDirectOrders()">Test Direct API</button>
      <button onclick="testSampleData()">Test Sample Orders</button>

      <div id="logs"></div>
    </div>

    <script>
      function log(message, type = "info") {
        const logContainer = document.getElementById("logs");
        if (!logContainer.innerHTML.includes("Test Logs")) {
          logContainer.innerHTML = "<h3>ðŸ“‹ Test Logs</h3>";
        }

        const timestamp = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `test-result ${type}`;
        div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        logContainer.appendChild(div);

        console.log(`[${timestamp}] ${message}`);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      async function testOrdersPage() {
        log("ðŸ”„ Testing access to admin orders page...", "info");

        try {
          // Try to access the admin orders page
          const response = await fetch("/admin/orders", {
            method: "GET",
            credentials: "include",
          });

          log(
            `ðŸ“¡ Admin orders page response: ${response.status} ${response.statusText}`,
            response.ok ? "success" : "error",
          );

          if (response.ok) {
            const html = await response.text();
            if (html.includes("Orders Management")) {
              log("âœ… Orders page loaded successfully!", "success");
            } else if (html.includes("login")) {
              log("ðŸ”’ Redirected to login - need authentication", "error");
            } else {
              log("âš ï¸ Page loaded but content unexpected", "error");
            }
          } else {
            log(`âŒ Failed to load orders page: ${response.status}`, "error");
          }
        } catch (error) {
          log(`ðŸ’¥ Error accessing orders page: ${error.message}`, "error");
        }
      }

      async function testDirectOrders() {
        log("ðŸ”„ Testing direct orders API access...", "info");

        try {
          // Try to fetch orders directly using Supabase API pattern
          const response = await fetch("/api/orders", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            log(
              `âœ… Orders API working: ${data.length || "unknown"} orders`,
              "success",
            );
            log(`ðŸ“Š Sample data: ${JSON.stringify(data.slice(0, 2))}`, "info");
          } else {
            log(`âŒ Orders API failed: ${response.status}`, "error");
            const errorText = await response.text();
            log(`ðŸ“„ Error response: ${errorText}`, "error");
          }
        } catch (error) {
          log(`ðŸ’¥ Direct API error: ${error.message}`, "error");
        }
      }

      async function testSampleData() {
        log("ðŸ”„ Testing with sample order creation...", "info");

        const sampleOrder = {
          order_number: `TEST-${Date.now()}`,
          customer_id: "test-customer-id",
          status: "pending",
          total_amount: 500,
          shipping_amount: 50,
          discount_amount: 0,
          tax_amount: 45,
          items: [
            {
              product_id: "test-product",
              product_name: "Test Flower Bouquet",
              quantity: 1,
              unit_price: 500,
              total_price: 500,
            },
          ],
          shipping_address: {
            name: "Test Customer",
            address_line_1: "123 Test Street",
            city: "Mumbai",
            state: "Maharashtra",
            pincode: "400001",
          },
          billing_address: {
            name: "Test Customer",
            address_line_1: "123 Test Street",
            city: "Mumbai",
            state: "Maharashtra",
            pincode: "400001",
          },
          payment_status: "pending",
        };

        try {
          log("ðŸ“¤ Creating sample order...", "info");
          const response = await fetch("/api/orders", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(sampleOrder),
            credentials: "include",
          });

          if (response.ok) {
            const result = await response.json();
            log("âœ… Sample order created successfully!", "success");
            log(`ðŸ†” Order ID: ${result.id}`, "info");
          } else {
            log(
              `âŒ Failed to create sample order: ${response.status}`,
              "error",
            );
            const errorText = await response.text();
            log(`ðŸ“„ Error: ${errorText}`, "error");
          }
        } catch (error) {
          log(`ðŸ’¥ Sample order creation failed: ${error.message}`, "error");
        }
      }

      // Auto-run basic test on page load
      window.addEventListener("load", () => {
        log("ðŸ”§ Orders page diagnostic tool loaded", "info");
        log('Click "Test Orders Page" to check if the page is working', "info");
      });
    </script>
  </body>
</html>
